# CartridgeMaster - python приложение для учёта картриджей.
Приложение будет использоваться для:
* учёта количества картриджей
* учёта еженедельного расхода
* прогнозов на будущие расходы из анализа истории.


Логически разделено на 2 модуля:
- Телеграм бот.
- Локальный веб-сервер, для обмена данными с приложением CartridgeScanner.

Информация о используемых версиях и зависимостях в файле requirements.txt  

## База данных
Используется локальная БД SQLite - database.db. Хранится в корне, в директории вместе с main.py.   
Состоит из таблиц cartridges, barcodes, users.  

Таблица cartridges. Связана с barcodes связью один ко многим:
| id | cartridge_name | quantity |     last_update      |
|----|----------------|----------|----------------------|
| 1  | Имя_картриджа_1 |     5   | 2026-02-18 14:03:43  |
| 2  | Имя_картриджа_2 |     2   | 2026-02-18 14:03:44  |  

Таблица barcodes. Столбец cartridge_id ссылается на первичный ключ id из первой таблицы cartridges.
| barcode | cartridge_id |
|----------------|---|
| 4004764390564  | 1 |
| 1234567891121  | 1 |
| 1234567891111  | 2 |

Таблица users. id в этой таблица просто уникальный порядковый номер.
| id | telegram_id | first_name |  notice_enable    |
|----|-------------|------------|-------------------|
| 1  |  123123123  |   User     |        1          |

## Бот на телеграм
Бот написан с использованием фреймворка aiogram, работает в асинхроне.

Диспетчер бота регистрирует и обрабатывает все события, получаемые от серверов телеграма.

## Веб-сервер и обмен c ТСД (Терминал сбора данных)
HTTP-сервер написан на aiohttp, работает в том же процессе, что и бот.
Работает по адресу http://local_ip:8080/scan принимает и обрабатывает json через POST-запросы, формируемые приложением CartridgeScanner.

## CartridgeScanner
Приложение CartridgeScanner устанавливается на Android устройство со встроенным сканером (тестилось на Android версии 9)
* Обмен данными осуществляется POST запросами к серваку - пока реализовано только добавление или уменьшение количества картриджей.
* Поскольку сырой http трафик передается в незашифрованном виде, перед тем как отправить POST, ТСД шифрует отправляемое json-сообщение алгоритмом AES. Аналогично, принятый ответ от сервера сначала расшифровывается.
* Ключ шифрования AES_KEY зашит в коде на серверной части и ТСД-шнике, но надо придумать что-то понадежнее.

## Что поменять?
Архитектура слишком завязана на телеграм, сейчас "админ-панель"  это по сути команды, отправляемые тг-боту. 
* Необходимо нормально реализовать crud операции, а не то, что имеем сейчас - всё что можно ТСД будем фигачить через POST?
Нужно сделать так, чтобы бот не напрямую дергал функцию базы, а взаимодействовал с ней через прослойку REST на веб-сервере.
А именно, отправлял веб-серваку GET, POST, PUT, PATCH, DELETE, а тот уже напрямую взаимодействовал с базой.
* Админ-панель сделать как сайт в локалке, но это получится, только после полного рефакторинга кода... 
* Когда телегу в России забанят и бот отвалится, нужно переходить на уведомления по почте.
